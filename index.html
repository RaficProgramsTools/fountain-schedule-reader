<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Feature Schedule</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary-color: #2563eb;
            --border-color: #e2e8f0;
            --header-bg: #f8fafc;
            --text-main: #1e293b;
            --text-secondary: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            line-height: 1.5;
            margin: 0;
            padding: 2rem;
            background-color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            color: var(--text-main);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 1rem;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f1f5f9;
            border-radius: 8px;
        }

        .control-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .controls input[type="file"],
        .controls input[type="month"] {
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
        }

        .checkbox-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9em;
            cursor: pointer;
            user-select: none;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn:hover {
            background-color: #1d4ed8;
        }

        .daily-schedule {
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .daily-header {
            background-color: var(--header-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .daily-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .schedule-name {
            font-weight: 400;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .events-list {
            padding: 1rem;
        }

        .warning-msg {
            color: #ef4444;
            font-weight: 600;
            text-align: center;
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .events-table th,
        .events-table td {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .events-table th {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        @media print {
            body {
                padding: 0;
            }

            .container {
                max-width: 100%;
            }

            .controls,
            .no-print {
                display: none !important;
            }

            .daily-schedule {
                border: 1px solid #000;
                break-inside: avoid;
            }

            h1 {
                font-size: 1.5rem;
                border-bottom: 1px solid #000;
            }

            .daily-header {
                background-color: #eee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
    <style>
        /* Existing styles... */

        /* Month Selector Styles */
        .month-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .month-btn {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            /* Slightly softer than default 4px */
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .month-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .month-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .prayer-times-container {
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            transition: all 0.3s ease;
        }

        /* Desktop: Floating Sidebar */
        @media (min-width: 1200px) {
            .prayer-times-container {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 300px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                z-index: 1000;
                margin-top: 0;
                background: white;
                border: 1px solid var(--border-color);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Water Feature Schedule</h1>

        <div class="controls no-print">
            <div class="control-row" id="file-section">
                <label>1. Load Schedule: </label>
                <input type="file" id="xmlFileInput" accept=".xml">
            </div>

            <div id="date-section" class="control-row"
                style="display:none; border-top: 1px solid #cbd5e1; padding-top: 1rem; width: 100%;">
                <div style="display:flex; flex-direction: column; gap: 0.5rem; align-items: center;">
                    <div>
                        <label>2. Select Month: </label>
                        <input type="month" id="monthPicker">
                    </div>

                    <div class="checkbox-group">
                        <span>Show:</span>
                        <label><input type="checkbox" class="day-filter" value="1" checked> Mon</label>
                        <label><input type="checkbox" class="day-filter" value="2" checked> Tue</label>
                        <label><input type="checkbox" class="day-filter" value="3" checked> Wed</label>
                        <label><input type="checkbox" class="day-filter" value="4" checked> Thu</label>
                        <label><input type="checkbox" class="day-filter" value="5" checked> Fri</label>
                        <label><input type="checkbox" class="day-filter" value="6" checked> Sat</label>
                        <label><input type="checkbox" class="day-filter" value="0" checked> Sun</label>
                    </div>

                    <button class="btn" id="generateBtn">Show Schedule</button>
                    <small style="color: #64748b;">(Uncheck days to hide them from the print list)</small>
                </div>
            </div>
        </div>

        <div class="controls no-print" style="margin-top: 1rem; border-top: 1px dashed #cbd5e1; padding-top: 1rem;">
            <div class="checkbox-group" style="justify-content: center; border: none; background: transparent;">
                <label style="font-weight: 600; color: var(--primary-color);">
                    <input type="checkbox" id="togglePrayerTimes"> View Monthly General Prayer Times
                </label>
            </div>

            <div id="prayer-times-section" style="display: none; margin-top: 1.5rem; animation: fadeIn 0.3s ease;">
                <div id="month-selector" class="month-selector">
                    <!-- Month buttons will be injected here -->
                </div>
            </div>
        </div>

        <div id="output-container">
            <p style="text-align:center; color: #64748b;">Please upload your current schedular file to begin.</p>
        </div>
    </div>

    <script>
        // ... existing XML logic ...

        // PRAYER TIMES DATA (CSV Embedded)
        const PRAYER_TIMES_CSV = `Date,Day,Fajr,Shuruq,Dhuha,Dhuhr,Asr,Maghrib,Isha
1/1/2026,Thursday,5:39,7:01,7:28,12:30,15:33,17:54,19:24
1/6/2026,Tuesday,5:41,7:02,7:29,12:32,15:36,17:57,19:27
1/11/2026,Sunday,5:42,7:03,7:30,12:34,15:39,18:00,19:30
1/16/2026,Friday,5:43,7:03,7:30,12:36,15:42,18:04,19:34
1/21/2026,Wednesday,5:43,7:03,7:30,12:38,15:45,18:07,19:37
1/26/2026,Monday,5:43,7:02,7:29,12:39,15:48,18:10,19:40
1/31/2026,Saturday,5:42,7:01,7:27,12:40,15:50,18:13,19:43
2/1/2026,Sunday,5:42,7:00,7:27,12:40,15:51,18:14,19:44
2/6/2026,Friday,5:40,6:58,7:24,12:41,15:53,18:17,19:47
2/11/2026,Wednesday,5:38,6:56,7:22,12:41,15:55,18:20,19:50
2/16/2026,Monday,5:36,6:53,7:19,12:41,15:56,18:23,19:53
2/21/2026,Saturday,5:33,6:50,7:15,12:40,15:57,18:25,19:55
2/26/2026,Thursday,5:30,6:46,7:11,12:40,15:58,18:27,19:57
3/1/2026,Sunday,5:27,6:44,7:09,12:39,15:58,18:29,19:59
3/6/2026,Friday,5:23,6:40,7:05,12:38,15:59,18:31,20:01
3/11/2026,Wednesday,5:19,6:35,7:00,12:37,15:58,18:33,20:03
3/16/2026,Monday,5:15,6:31,6:56,12:36,15:58,18:34,20:04
3/21/2026,Saturday,5:10,6:26,6:51,12:34,15:57,18:36,20:06
3/26/2026,Thursday,5:05,6:22,6:47,12:33,15:56,18:38,20:08
3/31/2026,Tuesday,5:00,6:17,6:42,12:31,15:54,18:39,20:09
4/1/2026,Wednesday,4:59,6:16,6:41,12:31,15:54,18:39,20:09
4/6/2026,Monday,4:54,6:12,6:37,12:29,15:53,18:41,20:11
4/11/2026,Saturday,4:49,6:07,6:32,12:28,15:51,18:43,20:13
4/16/2026,Thursday,4:44,6:03,6:28,12:27,15:49,18:44,20:14
4/21/2026,Tuesday,4:39,5:59,6:25,12:26,15:47,18:46,20:16
4/26/2026,Sunday,4:35,5:55,6:21,12:25,15:45,18:48,20:18
5/1/2026,Friday,4:30,5:52,6:18,12:24,15:43,18:50,20:20
5/6/2026,Wednesday,4:26,5:49,6:15,12:23,15:42,18:52,20:22
5/11/2026,Monday,4:23,5:46,6:12,12:23,15:40,18:54,20:24
5/16/2026,Saturday,4:20,5:44,6:10,12:23,15:39,18:56,20:26
5/21/2026,Thursday,4:17,5:42,6:09,12:23,15:37,18:58,20:28
5/26/2026,Tuesday,4:15,5:41,6:08,12:24,15:37,19:01,20:31
5/31/2026,Sunday,4:13,5:40,6:07,12:24,15:38,19:03,20:33
6/1/2026,Monday,4:13,5:40,6:07,12:25,15:38,19:03,20:33
6/6/2026,Saturday,4:12,5:40,6:07,12:25,15:41,19:05,20:35
6/11/2026,Thursday,4:11,5:40,6:07,12:26,15:43,19:07,20:37
6/16/2026,Tuesday,4:12,5:40,6:08,12:27,15:45,19:08,20:38
6/21/2026,Sunday,4:12,5:41,6:08,12:28,15:46,19:10,20:40
6/26/2026,Friday,4:14,5:42,6:10,12:30,15:47,19:11,20:41
7/1/2026,Wednesday,4:16,5:44,6:11,12:31,15:47,19:11,20:41
7/6/2026,Monday,4:18,5:46,6:13,12:31,15:47,19:11,20:41
7/11/2026,Saturday,4:20,5:48,6:14,12:32,15:46,19:11,20:41
7/16/2026,Thursday,4:23,5:49,6:16,12:33,15:45,19:10,20:40
7/21/2026,Tuesday,4:26,5:51,6:18,12:33,15:47,19:09,20:39
7/26/2026,Sunday,4:29,5:53,6:20,12:33,15:48,19:07,20:37
7/31/2026,Friday,4:32,5:55,6:22,12:33,15:50,19:05,20:35
8/1/2026,Saturday,4:32,5:56,6:22,12:33,15:50,19:04,20:34
8/6/2026,Thursday,4:35,5:58,6:24,12:33,15:51,19:02,20:32
8/11/2026,Tuesday,4:38,6:00,6:25,12:32,15:51,18:59,20:29
8/16/2026,Sunday,4:40,6:01,6:27,12:31,15:52,18:55,20:25
8/21/2026,Friday,4:43,6:03,6:28,12:30,15:51,18:51,20:21
8/26/2026,Wednesday,4:45,6:04,6:30,12:29,15:51,18:47,20:17
8/31/2026,Monday,4:47,6:06,6:31,12:27,15:50,18:43,20:13
9/1/2026,Tuesday,4:48,6:06,6:31,12:27,15:50,18:42,20:12
9/6/2026,Sunday,4:50,6:07,6:32,12:25,15:49,18:37,20:07
9/11/2026,Friday,4:52,6:09,6:34,12:24,15:47,18:32,20:02
9/16/2026,Wednesday,4:53,6:10,6:35,12:22,15:45,18:28,19:58
9/21/2026,Monday,4:55,6:11,6:36,12:20,15:43,18:23,19:53
9/26/2026,Saturday,4:56,6:13,6:37,12:18,15:41,18:18,19:48
10/1/2026,Thursday,4:58,6:14,6:39,12:17,15:38,18:13,19:43
10/6/2026,Tuesday,4:59,6:15,6:40,12:15,15:36,18:09,19:39
10/11/2026,Sunday,5:01,6:17,6:42,12:14,15:33,18:04,19:34
10/16/2026,Friday,5:02,6:19,6:44,12:12,15:31,18:00,19:30
10/21/2026,Wednesday,5:04,6:21,6:46,12:11,15:28,17:56,19:26
10/26/2026,Monday,5:06,6:23,6:49,12:11,15:26,17:53,19:23
10/31/2026,Saturday,5:08,6:25,6:51,12:10,15:24,17:50,19:20
11/1/2026,Sunday,5:08,6:26,6:52,12:10,15:24,17:49,19:19
11/6/2026,Friday,5:10,6:28,6:54,12:10,15:22,17:46,19:16
11/11/2026,Wednesday,5:12,6:31,6:58,12:11,15:21,17:44,19:14
11/16/2026,Monday,5:15,6:34,7:01,12:11,15:20,17:43,19:13
11/21/2026,Saturday,5:17,6:37,7:04,12:12,15:20,17:42,19:12
11/26/2026,Thursday,5:20,6:41,7:08,12:14,15:19,17:41,19:11
12/1/2026,Tuesday,5:23,6:44,7:11,12:16,15:20,17:41,19:11
12/6/2026,Sunday,5:26,6:47,7:14,12:18,15:21,17:42,19:12
12/11/2026,Friday,5:29,6:50,7:18,12:20,15:22,17:43,19:13
12/16/2026,Wednesday,5:31,6:53,7:21,12:22,15:24,17:45,19:15
12/21/2026,Monday,5:34,6:56,7:23,12:25,15:26,17:47,19:17
12/26/2026,Saturday,5:36,6:58,7:26,12:27,15:29,17:50,19:20
12/31/2026,Thursday,5:38,7:00,7:28,12:30,15:32,17:53,19:23`;

        let prayerTimesData = [];


        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(',');
                if (currentLine.length < headers.length) continue;

                const entry = {};
                for (let j = 0; j < headers.length; j++) {
                    entry[headers[j]] = currentLine[j].trim();
                }

                // Parse date for filtering
                // Format assumed M/D/YYYY from sample
                const [m, d, y] = entry.Date.split('/');
                entry.month = parseInt(m);
                entry.year = parseInt(y);
                entry.dateObj = new Date(y, m - 1, d);

                data.push(entry);
            }
            return data;
        }

        // Initialize Prayer Times Logic
        (function initPrayerTimes() {
            prayerTimesData = parseCSV(PRAYER_TIMES_CSV);

            const toggle = document.getElementById('togglePrayerTimes');
            const section = document.getElementById('prayer-times-section');
            const monthSelector = document.getElementById('month-selector');
            const outputContainer = document.getElementById('output-container');

            toggle.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                section.style.display = isChecked ? 'block' : 'none';

                if (isChecked) {
                    renderMonthSelector();
                } else {
                    // Hide the prayer times sidebar if unchecked
                    const existingTable = document.querySelector('.prayer-times-container');
                    if (existingTable) existingTable.style.display = 'none';
                }
            });

            function renderMonthSelector() {
                const months = [
                    "January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];

                monthSelector.innerHTML = '';
                months.forEach((m, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'month-btn';
                    btn.textContent = m;
                    btn.onclick = () => {
                        document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderPrayerTimes(index + 1, m);
                    };
                    monthSelector.appendChild(btn);
                });

                // If a month was previously selected (and we are just toggling visibility), restore it
                // For simplicity, we can default to current month if nothing is selected or let user select again
            }

            function renderPrayerTimes(monthIndex, monthName) {
                // Filter data
                const monthlyData = prayerTimesData.filter(d => d.month === monthIndex);

                // Check if we already have a container and remove it to redraw
                const existing = document.querySelector('.prayer-times-container');
                if (existing) existing.remove();

                if (monthlyData.length === 0) {
                    // Create a simple container for the error message
                    const errDiv = document.createElement('div');
                    errDiv.className = 'prayer-times-container';
                    errDiv.style.padding = '1rem';
                    errDiv.innerHTML = `<p class="warning-msg">No prayer times found for ${monthName}.</p>`;
                    document.body.appendChild(errDiv);
                    return;
                }

                // Build Table
                const container = document.createElement('div');
                container.className = 'prayer-times-container';

                const tableHtml = `
                    <div class="prayer-header">
                        General Monthly Prayer Times - ${monthName}
                    </div>
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Fajr</th>
                                <th>Shuruq</th>
                                <th>Dhuha</th>
                                <th>Dhuhr</th>
                                <th>Asr</th>
                                <th>Maghrib</th>
                                <th>Isha</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthlyData.map(row => `
                                <tr>
                                    <td>${row.Date}</td>
                                    <td>${row.Day}</td>
                                    <td>${row.Fajr}</td>
                                    <td>${row.Shuruq}</td>
                                    <td>${row.Dhuha}</td>
                                    <td>${row.Dhuhr}</td>
                                    <td>${row.Asr}</td>
                                    <td>${row.Maghrib}</td>
                                    <td>${row.Isha}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHtml;
                document.body.appendChild(container); // Append to body to ensure it can float independently
            }
        })();


    </script>
    <script>
        // Existing XML Logic

        let xmlData = {
            dayPlans: {},   // GUID -> { Name, Events: [] }
            weekPlans: {},  // GUID -> { Name, Days: { 0: DayGUID, 1: DayGUID... } }
            yearPlans: {}   // YearNumber -> [ { month, day, isDayPlan, guid, name } ]
        };

        const GERMAN_DAYS = { "Montag": 1, "Dienstag": 2, "Mittwoch": 3, "Donnerstag": 4, "Freitag": 5, "Samstag": 6, "Sonntag": 0 };

        document.getElementById('xmlFileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                parseXML(e.target.result);
                document.getElementById('file-section').style.opacity = '0.5';
                document.getElementById('date-section').style.display = 'flex';

                const now = new Date();
                const monthStr = (now.getMonth() + 1).toString().padStart(2, '0');
                document.getElementById('monthPicker').value = `${now.getFullYear()}-${monthStr}`;
            };
            reader.readAsText(file);
        });

        document.getElementById('generateBtn').addEventListener('click', generateCalendar);

        function parseXML(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");

            // 1. DayPlans
            for (let day of xmlDoc.getElementsByTagName("Day")) {
                const guid = day.getAttribute("GUID");
                const name = day.getAttribute("Name");
                const events = [];
                const items = day.getElementsByTagName("items")[0];
                if (items) {
                    for (let evt of items.getElementsByTagName("event")) {
                        events.push({
                            start: evt.getAttribute("StartBy"),
                            name: evt.getAttribute("EventName"),
                            duration: parseFloat(evt.getAttribute("Lenght") || "0")
                        });
                    }
                    events.sort((a, b) => parseTime(a.start) - parseTime(b.start));
                }
                xmlData.dayPlans[guid] = { name, events };
            }

            // 2. WeekPlans
            for (let week of xmlDoc.getElementsByTagName("Week")) {
                const guid = week.getAttribute("GUID");
                const name = week.getAttribute("Name");
                const dayMap = {};
                const items = week.getElementsByTagName("items")[0];
                if (items) {
                    for (let evt of items.getElementsByTagName("event")) {
                        const wdn = evt.getAttribute("Weekdayname");
                        if (GERMAN_DAYS.hasOwnProperty(wdn)) dayMap[GERMAN_DAYS[wdn]] = evt.getAttribute("DayplanGUID");
                    }
                }
                xmlData.weekPlans[guid] = { name, dayMap };
            }

            // 3. YearPlans
            for (let year of xmlDoc.getElementsByTagName("Year")) {
                const yearNum = parseInt(year.getAttribute("Yearnumber"));
                const events = [];
                const items = year.getElementsByTagName("items")[0];
                if (items) {
                    for (let evt of items.getElementsByTagName("event")) {
                        events.push({
                            month: parseInt(evt.getAttribute("MonthNumber")),
                            day: parseInt(evt.getAttribute("Daynumber")),
                            isDayPlan: evt.getAttribute("EventIsDayplan") === "True",
                            guid: evt.getAttribute("EventGUID"),
                            name: evt.getAttribute("EventName")
                        });
                    }
                }
                events.sort((a, b) => (a.month - b.month) || (a.day - b.day));
                xmlData.yearPlans[yearNum] = events;
            }
        }

        function generateCalendar() {
            const picker = document.getElementById('monthPicker');
            if (!picker.value) return;

            const [year, month] = picker.value.split('-').map(Number);
            const container = document.getElementById('output-container');
            container.innerHTML = '';

            // Get selected weekdays
            const selectedDays = new Set();
            document.querySelectorAll('.day-filter').forEach(cb => {
                if (cb.checked) selectedDays.add(parseInt(cb.value));
            });

            // Find the Active WeekPlan for this month.
            // We'll pick the 15th of the month as a representative date to find the prevailing schedule.
            const queryDate = new Date(year, month - 1, 15);

            // Collect Year Events
            let allYearEvents = [];
            if (xmlData.yearPlans[year - 1]) allYearEvents = allYearEvents.concat(xmlData.yearPlans[year - 1].map(e => ({ ...e, year: year - 1 })));
            if (xmlData.yearPlans[year]) allYearEvents = allYearEvents.concat(xmlData.yearPlans[year].map(e => ({ ...e, year: year })));

            allYearEvents.sort((a, b) => new Date(a.year, a.month - 1, a.day) - new Date(b.year, b.month - 1, b.day));

            let activeWeekPlan = null;
            for (let evt of allYearEvents) {
                const evtDate = new Date(evt.year, evt.month - 1, evt.day);
                if (evtDate > queryDate) break; // Future event

                if (!evt.isDayPlan) {
                    activeWeekPlan = evt;
                }
            }

            if (!activeWeekPlan) {
                container.innerHTML = '<p class="warning-msg">No General Schedule found for this month.</p>';
                return;
            }

            const weekObj = xmlData.weekPlans[activeWeekPlan.guid];
            if (!weekObj) {
                container.innerHTML = `<p class="warning-msg">Schedule "${activeWeekPlan.name}" is referenced but not defined in the XML.</p>`;
                return;
            }

            // Render 7 Days (Mon...Sun)
            const weekOrder = [1, 2, 3, 4, 5, 6, 0];
            const dayNames = { 1: "Monday", 2: "Tuesday", 3: "Wednesday", 4: "Thursday", 5: "Friday", 6: "Saturday", 0: "Sunday" };

            // Add Header Info indicating context
            const infoDiv = document.createElement('div');
            infoDiv.style.marginBottom = '1rem';
            infoDiv.style.padding = '0.5rem';
            infoDiv.style.backgroundColor = '#f0f9ff';
            infoDiv.style.borderLeft = '4px solid #2563eb';
            infoDiv.innerHTML = `<strong>Active Schedule:</strong> ${weekObj.name} <br> <span style="font-size:0.9em;color:#64748b">Showing typical weekly plan for ${picker.value}</span>`;
            container.appendChild(infoDiv);

            weekOrder.forEach(dayNum => {
                if (!selectedDays.has(dayNum)) return;

                const dayPlanGuid = weekObj.dayMap[dayNum];
                const dayName = dayNames[dayNum];

                renderWeekday(dayName, dayPlanGuid, container);
            });
        }

        function renderWeekday(dayName, planGuid, container) {
            const div = document.createElement('div');
            div.className = 'daily-schedule';

            let planContent = '';

            if (planGuid && xmlData.dayPlans[planGuid]) {
                const plan = xmlData.dayPlans[planGuid];

                const eventsHtml = plan.events.map(e => {
                    const startSec = parseTime(e.start);
                    const endSec = startSec + e.duration;
                    const endStr = formatTime(endSec);

                    return `
                        <tr>
                            <td style="width:120px;">${e.start}</td>
                            <td>${e.name}</td>
                            <td style="width:120px;">${endStr}</td>
                        </tr>
                    `}).join('');

                planContent = `
                    <div class="daily-header">
                        <h3>${dayName}</h3>
                        <span class="schedule-name">${plan.name}</span>
                    </div>
                    <div class="events-list">
                        ${eventsHtml ? `<table class="events-table"><thead><tr><th>Start</th><th>Event</th><th>End Time</th></tr></thead><tbody>${eventsHtml}</tbody></table>` : '<p>No events.</p>'}
                    </div>
                `;
            } else {
                planContent = `
                    <div class="daily-header" style="background-color: #fef2f2;">
                        <h3>${dayName}</h3>
                        <span class="schedule-name" style="color:red;">No Schedule Assigned</span>
                    </div>
                `;
            }
            div.innerHTML = planContent;
            container.appendChild(div);
        }

        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const cleanStr = timeStr.replace(/[a-z]/gi, '').trim();
            const parts = cleanStr.split(':');
            let h = 0, m = 0, s = 0;
            if (parts.length >= 1) h = parseInt(parts[0], 10);
            if (parts.length >= 2) m = parseInt(parts[1], 10);
            if (parts.length >= 3) s = Math.floor(parseFloat(parts[2]));
            if (timeStr.toLowerCase().includes('pm') && h < 12) h += 12;
            if (timeStr.toLowerCase().includes('am') && h === 12) h = 0;
            return h * 3600 + m * 60 + s;
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        } </script>
</body>

</html>
